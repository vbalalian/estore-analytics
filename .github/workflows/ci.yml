name: CI

on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ dev ]

env:
  CI_SCHEMA_PREFIX: ci_pr_${{ github.event.number || github.run_id }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install dbt-bigquery dagster dagster-dbt

    - name: Create keyfile
      run: |
        echo "${{ secrets.GCP_KEYFILE_BASE64 }}" | base64 -d > /tmp/keyfile.json
    
    - name: Authenticate with GCP
      run: |
        gcloud auth activate-service-account --key-file=/tmp/keyfile.json
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
      
    - name: Set up dbt profile
      run: |
        mkdir -p ~/.dbt
        cat > ~/.dbt/profiles.yml << EOF
        estore:
          target: ci
          outputs:
            ci:
              type: bigquery
              method: service-account
              project: ${{ secrets.GCP_PROJECT_ID }}
              dataset: "${{ env.CI_SCHEMA_PREFIX }}"
              keyfile: /tmp/keyfile.json
              threads: 4
              timeout_seconds: 300
        EOF

    - name: dbt deps
      run: |
        cd dbt-project
        dbt deps
    
    - name: Download production manifest
      id: download-manifest
      continue-on-error: true
      run: |
        mkdir -p dbt-project/target-prod
        gcloud storage cp gs://${{ secrets.GCS_ARTIFACTS_BUCKET }}/dbt/manifest.json \
          dbt-project/target-prod/manifest.json || echo "No production manifest found."

    - name: Check manifest status
      id: check-manifest
      run: |
        if [ -f "dbt-project/target-prod/manifest.json" ]; then
          echo "has_manifest=true" >> $GITHUB_OUTPUT
          echo "Production manifest found - using slim CI"
        else
          echo "has_manifest=false" >> $GITHUB_OUTPUT
          echo "No production manifest found - falling back to full build"
        fi
    
    - name: dbt clone (production incrementals)
      if: steps.check-manifest.outputs.has_manifest == 'true'
      run: |
        cd dbt-project
        echo "Cloning incremental models from production manifest"
        dbt clone \
          --select state:modified+,config.materialized:incremental,state:old \
          --state target-prod \
          --target ci \
          || echo "No incremental models to clone"

    - name: dbt build (slim)
      if: steps.check-manifest.outputs.has_manifest == 'true'
      run: |
        cd dbt-project
        echo "Building modified models + downstream based on production manifest"
        dbt build \
          --select state:modified+ \
          --defer \
          --state target-prod \
          --target ci \
          --fail-fast

    - name: dbt build (full)
      if: steps.check-manifest.outputs.has_manifest == 'false'
      run: |
        cd dbt-project
        dbt build --target ci --fail-fast

    - name: Lint dbt models with SQLFluff
      run: |
        pip install sqlfluff sqlfluff-templater-dbt
        cd dbt-project
        sqlfluff lint

    - name: Cleanup CI schema
      if: always()
      run: |
        echo "Cleaning up schema: ${{ env.CI_SCHEMA_PREFIX }}"
        
        for dataset in $(bq ls --format=sparse | grep "${{ env.CI_SCHEMA_PREFIX }}"); do
          echo "Dropping dataset: $dataset"
          bq rm -r -f "${{ secrets.GCP_PROJECT_ID }}:$dataset"
        done
        
        echo "Cleanup complete"