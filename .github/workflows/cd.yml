name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to GCP VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          set -e

          cd ${{ vars.DEPLOY_PATH }}
          git pull origin main
          
          source .venv/bin/activate

          cd ${{ vars.DEPLOY_PATH }}/dbt-project
          dbt clean
          dbt deps
          dbt parse
          dbt compile
          
          cd ${{ vars.DEPLOY_PATH }}/dagster-project
          
          echo "Checking for dependency changes..."
          if git diff --name-only HEAD@{1} HEAD | grep -E '(^|/)pyproject.toml$|(^|/)requirements.txt$'; then
            echo "Dependencies changed — upgrading environment..."
            pip install --upgrade pip
            pip install --upgrade -e .[dev]

            echo "Restarting Dagster services..."
            dagster-dbt project prepare-and-package --components .
            sudo systemctl restart dagster-webserver
            sudo systemctl restart dagster
          else
            echo "No dependency changes detected — reloading code definitions only..."
            dagster-dbt project prepare-and-package --components .
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{"query": "mutation { reloadWorkspace { __typename } }"}' \
              http://localhost:3000/graphql
          fi

          echo "Uploading manifest to GCS for slim CI..."
          gcloud storage cp ${{ vars.DEPLOY_PATH }}/dbt-project/target/manifest.json \
            gs://${{ secrets.GCS_ARTIFACTS_BUCKET }}/dbt/manifest.json

          echo "Deployment complete!"
