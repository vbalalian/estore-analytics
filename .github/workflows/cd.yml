name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to GCP VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          cd /home/vbalalian/estore-analytics
          git pull origin main
          
          source .venv/bin/activate

          echo "Checking for dependency changes..."
          if git diff --name-only HEAD@{1} HEAD | grep -E '(^|/)pyproject.toml$|(^|/)requirements.txt$'; then
            echo "Dependencies changed — upgrading environment..."
            pip install --upgrade pip
            pip install --upgrade -e .[dev]

            echo "Restarting Dagster services..."
            sudo systemctl restart dagster-webserver
            sudo systemctl restart dagster-daemon
          else
            echo "No dependency changes detected — reloading code definitions only..."
            cd /home/vbalalian/estore-analytics/dagster-project
            dagster-dbt project prepare-and-package --components .
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{"query": "mutation { reloadWorkspace { __typename } }"}' \
              http://localhost:3000/graphql
          fi

          echo "Deployment complete!"
