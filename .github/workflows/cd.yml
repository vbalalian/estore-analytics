name: CD

on:
  push:
    branches: [ main ]
    paths:
      - 'dbt-project/**'
      - 'dagster-project/**'
      - '.github/workflows/cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Store previous commit for rollback
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          cd ${{ vars.DEPLOY_PATH }}
          git rev-parse HEAD > /tmp/previous_commit
          echo "Stored current commit for potential rollback: $(cat /tmp/previous_commit)"

    - name: Deploy to GCP VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          set -e

          cd ${{ vars.DEPLOY_PATH }}
          git pull origin main
          
          source .venv/bin/activate

          cd ${{ vars.DEPLOY_PATH }}/dbt-project
          dbt clean
          dbt deps
          dbt parse
          dbt compile
          
          cd ${{ vars.DEPLOY_PATH }}/dagster-project
          
          echo "Checking for dependency changes..."
          if git diff --name-only HEAD@{1} HEAD | grep -E '(^|/)pyproject.toml$|(^|/)requirements.txt$'; then
            echo "Dependencies changed — upgrading environment..."
            pip install --upgrade pip
            pip install --upgrade -e .[dev]

            echo "Restarting Dagster services..."
            dagster-dbt project prepare-and-package --components .
            sudo systemctl restart dagster-webserver
            sudo systemctl restart dagster
          else
            echo "No dependency changes detected — reloading code definitions only..."
            dagster-dbt project prepare-and-package --components .
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{"query": "mutation { reloadWorkspace { __typename } }"}' \
              http://localhost:3000/graphql
          fi

          echo "Uploading manifest to GCS for slim CI..."
          gcloud auth activate-service-account --key-file=${{ vars.DEPLOY_PATH }}/.gcp/keyfile.json
          gcloud storage cp ${{ vars.DEPLOY_PATH }}/dbt-project/target/manifest.json \
            gs://${{ secrets.GCS_ARTIFACTS_BUCKET }}/dbt/manifest.json

          echo "Deployment complete!"

    - name: Refresh Omni schema
      id: omni_refresh
      if: success()
      continue-on-error: true
      run: |
        if ! git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- dbt-project/models/ | grep -q .; then
          echo "No dbt model changes — skipping Omni schema refresh."
          echo "omni_refresh_result=skipped" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "dbt model changes detected — refreshing Omni schema..."
        RESPONSE=$(curl -sf -X POST \
          "${{ secrets.OMNI_BASE_URL }}/api/v1/models/${{ secrets.OMNI_MODEL_ID }}/refresh" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.OMNI_API_KEY }}")

        JOB_ID=$(echo "$RESPONSE" | jq -r '.jobId')
        if [ -z "$JOB_ID" ] || [ "$JOB_ID" = "null" ]; then
          echo "Failed to extract jobId from response: $RESPONSE"
          echo "omni_refresh_result=failed" >> "$GITHUB_OUTPUT"
          exit 1
        fi
        echo "Omni refresh triggered (jobId: $JOB_ID). Polling for completion..."

        MAX_ATTEMPTS=30
        POLL_INTERVAL=10
        for i in $(seq 1 $MAX_ATTEMPTS); do
          STATUS_RESPONSE=$(curl -sf \
            "${{ secrets.OMNI_BASE_URL }}/api/v1/jobs/${JOB_ID}/status" \
            -H "Authorization: Bearer ${{ secrets.OMNI_API_KEY }}")
          STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')

          if [ "$STATUS" = "COMPLETED" ]; then
            echo "Omni schema refresh completed successfully."
            echo "omni_refresh_result=completed" >> "$GITHUB_OUTPUT"
            exit 0
          elif [ "$STATUS" = "FAILED" ]; then
            echo "Omni schema refresh failed: $STATUS_RESPONSE"
            echo "omni_refresh_result=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "Attempt $i/$MAX_ATTEMPTS — status: $STATUS. Waiting ${POLL_INTERVAL}s..."
          sleep $POLL_INTERVAL
        done

        echo "Omni schema refresh timed out after $((MAX_ATTEMPTS * POLL_INTERVAL))s."
        echo "omni_refresh_result=timeout" >> "$GITHUB_OUTPUT"
        exit 1

    - name: Notify Slack - Omni Refresh Failed
      if: steps.omni_refresh.outputs.omni_refresh_result == 'failed' || steps.omni_refresh.outputs.omni_refresh_result == 'timeout'
      continue-on-error: true
      uses: slackapi/slack-github-action@v2.0.0
      with:
        method: chat.postMessage
        token: ${{ secrets.SLACK_BOT_TOKEN }}
        payload: |
          channel: "#estore-alerts"
          text: "Omni schema refresh ${{ steps.omni_refresh.outputs.omni_refresh_result }}"
          blocks:
            - type: section
              text:
                type: mrkdwn
                text: ":warning: *Omni Schema Refresh ${{ steps.omni_refresh.outputs.omni_refresh_result == 'failed' && 'Failed' || 'Timed Out' }}*\n\n*Repo:* ${{ github.repository }}\n*Commit:* `${{ github.sha }}`\n*By:* ${{ github.actor }}"
            - type: actions
              elements:
                - type: button
                  text:
                    type: plain_text
                    text: View Run
                  url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Health check - Dagster webserver
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          set -e

          echo "Checking Dagster webserver..."

          if ! systemctl is-active --quiet dagster-webserver; then
            echo "Dagster webserver is not running!"
            sudo systemctl status dagster-webserver --no-pager
            exit 1
          fi
          echo "Dagster webserver is running."

          MAX_RETRIES=5
          RETRY_DELAY=3

          for i in $(seq 1 $MAX_RETRIES); do
            if curl -sf http://localhost:3000/server_info > /dev/null 2>&1; then
              echo "Dagster webserver HTTP endpoint is healthy."
              exit 0
            fi
              echo "Attempt $i/$MAX_RETRIES - waiting ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
          done

          echo "Dagster webserver HTTP endpoint is not responding!"
          exit 1

    - name: Health check - Dagster daemon
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          set -e

          echo "Checking Dagster daemon..."

          if ! systemctl is-active --quiet dagster; then
            echo "Dagster daemon is not running!"
            sudo systemctl status dagster --no-pager
            exit 1
          fi
          echo "Dagster daemon is running."

    - name: Cleanup on success
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          rm -f /tmp/previous_commit

    - name: Notify Slack - Deploy Success
      if: success()
      continue-on-error: true
      uses: slackapi/slack-github-action@v2.0.0
      with:
        method: chat.postMessage
        token: ${{ secrets.SLACK_BOT_TOKEN }}
        payload: |
          channel: "#estore-alerts"
          text: "Deployment successful"
          blocks:
            - type: section
              text:
                type: mrkdwn
                text: ":white_check_mark: *Deployment Successful*\n\n*Repo:* ${{ github.repository }}\n*Commit:* `${{ github.sha }}`\n*By:* ${{ github.actor }}"
            - type: actions
              elements:
                - type: button
                  text:
                    type: plain_text
                    text: View Run
                  url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  rollback:
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()

    steps:
    - name: Rollback to previous commit
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          set -e

          cd ${{ vars.DEPLOY_PATH }}
          
          if [ ! -f /tmp/previous_commit ]; then
            echo "No previous commit found for rollback!"
            exit 1
          fi

          PREVIOUS_COMMIT=$(cat /tmp/previous_commit)
          CURRENT_COMMIT=$(git rev-parse HEAD)

          echo "Rolling back..."
          echo "From: $CURRENT_COMMIT" 
          echo "To:   $PREVIOUS_COMMIT"

          git reset --hard $PREVIOUS_COMMIT

          source .venv/bin/activate

          cd ${{ vars.DEPLOY_PATH }}/dbt-project
          dbt clean
          dbt deps
          dbt parse
          dbt compile

          cd ${{ vars.DEPLOY_PATH }}/dagster-project
          pip install --upgrade -e .[dev]

          dagster-dbt project prepare-and-package --components .
          sudo systemctl restart dagster-webserver
          sudo systemctl restart dagster

          sleep 5

          if systemctl is-active --quiet dagster-webserver && systemctl is-active --quiet dagster; then
            echo "Rollback successful, services are running."
          else
            echo "Rollback completed, but services may not be running correctly."
            exit 1
          fi

    - name: Cleanup rollback file
      if: always()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          rm -f /tmp/previous_commit

    - name: Notify Slack - Rollback
      if: always()
      continue-on-error: true
      uses: slackapi/slack-github-action@v2.0.0
      with:
        method: chat.postMessage
        token: ${{ secrets.SLACK_BOT_TOKEN }}
        payload: |
          channel: "#estore-alerts"
          text: "Deployment failed - rollback attempted"
          blocks:
            - type: section
              text:
                type: mrkdwn
                text: ":rotating_light: *Deployment Failed - Rollback ${{ job.status }}*\n\n*Repo:* ${{ github.repository }}\n*Commit:* `${{ github.sha }}`\n*By:* ${{ github.actor }}"
            - type: actions
              elements:
                - type: button
                  text:
                    type: plain_text
                    text: View Run
                  url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}