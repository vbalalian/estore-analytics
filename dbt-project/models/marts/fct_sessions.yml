version: 2

models:
  - name: fct_sessions
    description: >
      Session fact table that applies a 1-hour inactivity timeout to split
      sessions spanning unreasonably long periods. 2.16% of sessions in the raw data
      span up to 6 months due to session IDs being reused without an inactivity timeout.
      This model detects gaps >3600 seconds between consecutive events within a session
      and assigns new session IDs at each timeout boundary.
    columns:
      - name: session_id
        description: >
          Cleaned session identifier. Original session ID if no timeout occurred,
          or original_id + '_timeout_' + occurrence_number for split sessions.
        tests:
          - not_null
          - unique

      - name: session_start_time
        description: "Timestamp of the first event in the session"
        tests:
          - not_null

      - name: session_start_date
        description: "Date of the first event in the session, used for partitioning"

      - name: user_id
        description: "Identifier for the user who initiated the session"
        tests:
          - not_null
          - relationships:
              to: ref('dim_users')
              field: user_id

      - name: session_end_time
        description: "Timestamp of the last event in the session"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= session_start_time"

      - name: event_count
        description: Total number of events (page views, cart additions, purchases) that occurred during
          the session
        tests:
          - not_null

      - name: unique_product_count
        description: "Number of unique products interacted with during the session"
        tests:
          - not_null

      - name: cart_additions
        description: "Total number of add-to-cart events during the session"

      - name: purchase_count
        description: "Total number of purchase events during the session"

      - name: view_count
        description: "Total number of view events during the session"

      - name: total_revenue
        description: Revenue generated in the session. NULL for non-purchasing sessions (expected behavior).
          For purchasing sessions, represents the transaction value
        tests:
          - assert_non_negative

      - name: session_length
        description: Duration of the session in seconds
        tests:
          - assert_non_negative

      - name: reached_view
        description: "Indicator (1/0) if the session included at least one view event"

      - name: reached_cart
        description: "Indicator (1/0) if the session included at least one add-to-cart event"

      - name: reached_purchase
        description: "Indicator (1/0) if the session included at least one purchase event"

      - name: funnel_stage
        description: 'Indicates the furthest stage reached in the conversion funnel during the session.
          Values: ''view'' (product viewed), ''cart'' (item added to cart), ''purchase'' (transaction
          completed), or NULL for sessions that didn''t reach any stage'
        tests:
          - accepted_values:
              arguments:
                values: ['purchase', 'cart', 'view', 'no_activity']

      # Omni semantic layer dimensions (computed at query time, not physical columns)
      # Pushed from Omni via bi-directional dbt integration

      - name: is_converting_session
        description: 'Binary indicator: 1 if the session resulted in at least one purchase, 0 otherwise'

      - name: session_length_bucket
        description: >
          Categorizes sessions by duration.
          Very Short (0-60s), Short (61-300s), Medium (301-600s), Long (600+s)

      - name: session_quality_tier
        description: >
          Engagement-based quality tier.
          Low: <150 sec or <3 events. Medium: 150-600 sec and 3-10 events. High: >600 sec or >10 events

      - name: user_purchase_history_group
        description: >
          Groups users by historical purchase count.
          Non-customers (0), Repeat (1-5), Loyal (6+)
