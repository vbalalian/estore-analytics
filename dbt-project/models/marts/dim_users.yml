version: 2

models:
  - name: dim_users
    description: >
      Dimension table for users. Extracted from staging events data.
    columns:
      - name: user_id
        description: "Unique identifier for the user"
        tests:
          - not_null
          - unique

      - name: first_event_time
        description: "Timestamp of the user's first interaction with the platform"
        tests:
          - not_null

      - name: first_event_date
        description: "Date of the user's first interaction with the platform"
        tests:
          - not_null

      - name: last_event_time
        description: "Timestamp of the user's most recent interaction with the platform"
        tests:
          - not_null
      
      - name: last_event_date
        description: "Date of the user's most recent interaction with the platform"
        tests:
          - not_null

      - name: session_count
        description: "Total number of sessions for the user, sourced from fct_sessions (sessions split at 1-hour inactivity gaps). 0 if no sessions exist."
        tests:
          - not_null
      
      - name: event_count
        description: "Total number of events generated by the user"
        tests:
          - not_null

      - name: total_revenue
        description: "Total revenue generated by the user"
        tests:
          - assert_non_negative
      
      - name: purchase_count
        description: "Total number of purchase events generated by the user"
      
      - name: first_purchase_date
        description: "Date of the user's first purchase event"

      - name: last_purchase_date
        description: "Date of the user's most recent purchase event"
      
      - name: avg_order_value
        description: "Average order value for the user"
        tests:
          - assert_non_negative
      
      - name: customer_lifespan_days
        description: "Number of days between the user's first and last purchase. Minimum 1 for any user with at least one purchase. NULL for non-purchasers."
      
      - name: days_since_last_activity
        description: "Number of days between the most recent event_date in the dataset (reference date) and this user's last event. Reference date is max(event_date) from fct_events."

      - name: days_since_last_purchase
        description: "Number of days between the most recent event_date in the dataset (reference date) and this user's last purchase. NULL for non-purchasers. Reference date is max(event_date) from fct_events."
      
      - name: activity_status
        description: "User activity status based on purchase recency and browsing activity. Churned requires both purchase and activity to have lapsed beyond churn_threshold_days."
        tests:
          - accepted_values:
              arguments:
                values: ['active', 'declining', 'at_risk', 'churned', 'prospect']

      - name: is_churned
        description: "Flag for churned users (1 for churned, 0 otherwise). Requires both days_since_last_purchase and days_since_last_activity to exceed churn_threshold_days."

      - name: customer_ltv
        description: "Customer lifetime value. Same as total_revenue; just semantic clarity."
        tests:
          - assert_non_negative

      - name: has_purchase_history
        description: "Boolean flag indicating whether the user has made at least one purchase."
        tests:
          - not_null

      - name: data_quality_flag
        description: "Data quality indicator. NULL when no issues detected. 'missing_sessions' if session_count is 0. 'anomalous_session_ratio' if events-per-session exceeds session_outlier_ratio var."
        tests:
          - accepted_values:
              arguments:
                values: ['missing_sessions', 'anomalous_session_ratio']
              config:
                where: "data_quality_flag is not null"

