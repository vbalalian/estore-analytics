version: 2

models:
  - name: dim_users
    description: >
      Dimension table for users. Extracted from staging events data.
    columns:
      - name: user_id
        description: "Unique identifier for the user"
        tests:
          - not_null
          - unique

      - name: first_event_time
        description: Timestamp of the user's first interaction
        tests:
          - not_null

      - name: first_event_date
        description: Date of the user's first interaction
        tests:
          - not_null

      - name: last_event_time
        description: Timestamp of the user's most recent interaction
        tests:
          - not_null
      
      - name: last_event_date
        description: Date of the user's most recent interaction
        tests:
          - not_null

      - name: session_count
        description: Total sessions for the user (cleaned, 1-hour inactivity timeout)
        tests:
          - not_null
      
      - name: event_count
        description: Total events generated by the user
        tests:
          - not_null

      - name: total_revenue
        description: Total revenue generated by the user (row-level)
        tests:
          - assert_non_negative
      
      - name: purchase_count
        description: Total purchase events for the user
      
      - name: first_purchase_date
        description: Date of the user's first purchase

      - name: last_purchase_date
        description: Date of the user's most recent purchase
      
      - name: avg_order_value
        description: "Average order value for the user"
        tests:
          - assert_non_negative
      
      - name: customer_lifespan_days
        description: Days between first and last purchase. NULL for non-purchasers
      
      - name: days_since_last_activity
        description: Days since the user's last event (relevant to dataset end date)

      - name: days_since_last_purchase
        description: Days since the user's last purchase. NULL for non-purchasers
      
      - name: activity_status
        description: User activity status (active, declining, at_risk, churned, or prospect)
        tests:
          - accepted_values:
              arguments:
                values: ['active', 'declining', 'at_risk', 'churned', 'prospect']

      - name: is_churned
        description: 1 if churned, 0 otherwise

      - name: customer_ltv
        description: Customer lifetime value (same as total_revenue)
        tests:
          - assert_non_negative

      - name: has_purchase_history
        description: True if the user has made at least one purchase
        tests:
          - not_null

      - name: data_quality_flag
        description: NULL when clean. 'missing_sessions' or 'anomalous_session_ratio' when issues detected
        tests:
          - accepted_values:
              arguments:
                values: ['missing_sessions', 'anomalous_session_ratio']
              config:
                where: "data_quality_flag is not null"


      - name: avg_order_value_bin
        description: Average order value for the user
      - name: customer_lifecycle_stage
        description: Lifecycle stage based on purchase count
      - name: total_revenue_bin
        description: Total revenue generated by the user (row-level)
