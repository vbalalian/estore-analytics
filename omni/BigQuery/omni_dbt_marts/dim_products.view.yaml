# Reference this view as omni_dbt_marts__dim_products
schema_label: ""
#This description was pulled from dbt.
description: |
  Dimension table for products. Extracted from staging events data.

schema: omni_dbt_marts
table_name: dim_products

dimensions:
  brand:
    #This description was pulled from dbt.
    description: Brand of the product

  category_code:
    #This description was pulled from dbt.
    description: Category code associated with the product
    hidden: true

  category_lvl_1:
    #This description was pulled from dbt.
    description: First level of hierarchical category associated with the product

  category_lvl_2:
    #This description was pulled from dbt.
    description: Second level of hierarchical category associated with the product

  category_lvl_3:
    #This description was pulled from dbt.
    description: Third level of hierarchical category associated with the product

  category_lvl_4:
    #This description was pulled from dbt.
    description: Fourth level of hierarchical category associated with the product

  product_id:
    format: ID
    #This description was pulled from dbt.
    description: Unique identifier for the product
    hidden: true
    primary_key: true

measures:
  count:
    aggregate_type: count

  unique_brands:
    sql: ${omni_dbt_marts__dim_products.brand}
    label: Unique Brands
    format: BIGNUMBER_0
    description: Count of distinct brands in the current grouping
    aggregate_type: count_distinct

  unique_categories:
    sql: ${omni_dbt_marts__dim_products.category_lvl_1}
    label: Unique Categories
    format: BIGNUMBER_0
    description: Count of distinct top-level product categories in the current grouping
    aggregate_type: count_distinct

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: dim_products
  target_schema: estore
  description: |
    Dimension table for products. Extracted from staging events data.
  config:
    schema: marts
    materialized: incremental
  code: |-
    {{ config(
        materialized = 'incremental',
        unique_key = 'product_id',
        incremental_strategy = 'merge',
        on_schema_change = 'sync_all_columns'
    ) }}

    with

    {{ incremental_max_date_cte('fct_events') }}

    events_source as (

        select * from {{ ref('fct_events') }}
        {{ incremental_date_filter() }}

    ),

    categories as (

        select * from {{ ref('dim_categories') }}

    ),

    product_attributes as (

        select

            product_id,
            brand,
            category_id,
            count(*) as frequency

        from events_source

        group by product_id, brand, category_id

    ),

    distinct_products_ranked as (

        select

            *,
            row_number()
                over (partition by product_id order by frequency desc)
                as rank

        from product_attributes

    ),

    final as (

        select distinct

            distinct_products_ranked.product_id,
            distinct_products_ranked.brand,
            categories.category_code,
            categories.category_lvl_1,
            categories.category_lvl_2,
            categories.category_lvl_3,
            categories.category_lvl_4

        from distinct_products_ranked

        left join categories
            on distinct_products_ranked.category_id = categories.raw_category_id

        where distinct_products_ranked.rank = 1

    )

    select * from final
