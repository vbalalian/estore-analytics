# Reference this view as omni_dbt_marts__metrics_conversion_rates
schema_label: ""
#This description was pulled from dbt.
description: A table containing daily and overall session conversion rates.

schema: omni_dbt_marts
table_name: metrics_conversion_rates

dimensions:
  metric_level:
    #This description was pulled from dbt.
    description: The aggregate level of the metric.

  time_period:
    #This description was pulled from dbt.
    description: The time period for the conversion rate (e.g., daily, overall).

  total_sessions:
    #This description was pulled from dbt.
    description: The total number of sessions recorded.

  sessions_with_view:
    #This description was pulled from dbt.
    description: The number of sessions that included at least one view event.

  sessions_with_cart:
    #This description was pulled from dbt.
    description: The number of sessions that included at least one cart event.

  sessions_with_purchase:
    #This description was pulled from dbt.
    description: The number of sessions that included at least one purchase event.

  view_to_cart_rate:
    #This description was pulled from dbt.
    description: The conversion rate from view to cart.

  cart_to_purchase_rate:
    #This description was pulled from dbt.
    description: The conversion rate from cart to purchase.

  view_to_purchase_rate:
    #This description was pulled from dbt.
    description: The conversion rate from view to purchase.

  total_revenue:
    #This description was pulled from dbt.
    description: The total revenue generated from purchase sessions.

  avg_order_value:
    #This description was pulled from dbt.
    description: The average order value for purchase sessions.

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: metrics_conversion_rates
  target_schema: estore
  description: A table containing daily and overall session conversion rates.
  config:
    schema: marts
    materialized: table
  code: |-
    {{ config(
        materialized='table'
    ) }}

    with source_sessions as (
        select * from {{ ref('fct_sessions') }}
    ),

    overall_metrics as (
        select
            'overall' as metric_level,
            'all_time' as time_period,

            count(distinct session_id) as total_sessions,
            sum(reached_view) as sessions_with_view,
            sum(reached_cart) as sessions_with_cart,
            sum(reached_purchase) as sessions_with_purchase,

            {{ rate_metric('sum(reached_cart)', 'sum(reached_view)') }}
                as view_to_cart_rate,
            {{ rate_metric('sum(reached_purchase)', 'sum(reached_cart)') }}
                as cart_to_purchase_rate,
            {{ rate_metric('sum(reached_purchase)', 'sum(reached_view)') }}
                as view_to_purchase_rate,

            round(sum(total_revenue), 2) as total_revenue,
            round(avg(case when reached_purchase = 1 then total_revenue end), 2)
                as avg_order_value

        from source_sessions
    ),

    daily_metrics as (
        select
            'daily' as metric_level,
            cast(session_start_date as string) as time_period,

            count(distinct session_id) as total_sessions,
            sum(reached_view) as sessions_with_view,
            sum(reached_cart) as sessions_with_cart,
            sum(reached_purchase) as sessions_with_purchase,

            {{ rate_metric('sum(reached_cart)', 'sum(reached_view)') }}
                as view_to_cart_rate,
            {{ rate_metric('sum(reached_purchase)', 'sum(reached_cart)') }}
                as cart_to_purchase_rate,
            {{ rate_metric('sum(reached_purchase)', 'sum(reached_view)') }}
                as view_to_purchase_rate,

            round(sum(total_revenue), 2) as total_revenue,
            round(avg(case when reached_purchase = 1 then total_revenue end), 2)
                as avg_order_value

        from source_sessions
        group by session_start_date
    ),

    final as (
        select * from overall_metrics
        union all
        select * from daily_metrics
    )

    select * from final
  referenced_by: [ vw_daily_conversion_metrics ]
